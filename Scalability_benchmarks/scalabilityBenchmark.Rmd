---
title: "scalabilityBenchmark"
author: "Jeroen Gilis"
date: "13/07/2022"
output: html_document
---

Running this script requires putting the folder 
`Results < Scalability_benchmarks` in the `Data` folder of this repository 
(unzipped). The `Scalability_benchmarks` folder can either be generated by 
running the Unix executable "runtime" or downloaded from Zenodo.  

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Load libraries

```{r, message=FALSE}
library(ggplot2)
library(tidyverse)
```

# Read and wrangle single-cell results

```{r}
# read satuRn results
load("./singlecell/satuRn_1.RData")
load("./singlecell/satuRn_2.RData")

# read limmaDiffsplice results
load("./singlecell/limmaDiffsplice_1.RData")
load("./singlecell/limmaDiffsplice_2.RData")

# read edgeRDiffsplice results
load("./singlecell/edgeRDiffsplice_1.RData")
load("./singlecell/edgeRDiffsplice_2.RData")

# read DRIMSeq results
load("./singlecell/DRIMSeq_1.RData")
load("./singlecell/DRIMSeq_2.RData")

# read DoubleExpSeq results
load("./singlecell/DoubleExpSeq_1.RData")
load("./singlecell/DoubleExpSeq_2.RData")

# read DEXSeq results
load("./singlecell/DEXSeq_2.RData")
load("./singlecell/DEXSeq_3.RData")
load("./singlecell/DEXSeq_4.RData")

# read BANDITS results
load("./singlecell/BANDITS_5.RData")
load("./singlecell/BANDITS_6.RData")

Results_all <- c(satuRn_1,
                 satuRn_2,
                 limmaDiffsplice_1,
                 limmaDiffsplice_2,
                 edgeRDiffsplice_1,
                 edgeRDiffsplice_2,
                 DRIMSeq_1,
                 DRIMSeq_2,
                 DoubleExpSeq_1,
                 DoubleExpSeq_2,
                 DEXSeq_2,
                 DEXSeq_3,
                 DEXSeq_4,
                 BANDITS_5,
                 BANDITS_6)
rm(list=setdiff(ls(), "Results_all"))

sc_results <-  as.data.frame(matrix(nrow = length(Results_all), ncol=10))

colnames(sc_results) <- c("method", 
                          "groupSize", 
                          "TXs", 
                          "TXs_round", 
                          "user", 
                          "system", 
                          "elapsed", 
                          "DTU", 
                          "removed", 
                          "memory")

sc_results$method <- rep(c("satuRn",
                           "limmaDiffsplice",
                           "edgeRDiffsplice",
                           "DRIMSeq",
                           "DoubleExpSeq",
                           "DEXSeq",
                           "BANDITS"),
                          times=c(24,24,24,24,24,16,7)) # add method labels

round_to <- function(x, to = 1000) round(x/to)*to

# get data in dataframe format
for (i in seq_len(nrow(sc_results))) {
  sc_results$groupSize[i] <- Results_all[[i]]$info$size
  sc_results$TXs[i] <- Results_all[[i]]$info$TXs
  sc_results$TXs_round[i] <- round_to(sc_results$TXs[i])
  sc_results$user[i] <- unname(Results_all[[i]]$timing[1])
  sc_results$system[i] <- unname(Results_all[[i]]$timing[2])
  sc_results$elapsed[i] <- unname(Results_all[[i]]$timing[3])
  sc_results$DTU[i] <- ifelse(is.null(Results_all[[i]]$result),
                                  NA,
                                  Results_all[[i]]$result)
  sc_results$removed[i] <- Results_all[[i]]$removed
  sc_results$memory[i] <- Results_all[[i]]$memory[4]
}
```

# Read and wrangle bulk results

```{r}
# read satuRn results
load("./bulk/satuRn_1.RData")
load("./bulk/satuRn_2.RData")

# read limmaDiffsplice results
load("./bulk/limmaDiffsplice_1.RData")
load("./bulk/limmaDiffsplice_2.RData")

# read edgeRDiffsplice results
load("./bulk/edgeRDiffsplice_1.RData")
load("./bulk/edgeRDiffsplice_2.RData")

# read DRIMSeq results
load("./bulk/DRIMSeq_1.RData")
load("./bulk/DRIMSeq_2.RData")

# read DoubleExpSeq results
load("./bulk/DoubleExpSeq_1.RData")
load("./bulk/DoubleExpSeq_2.RData")

# read DEXSeq results
load("./bulk/DEXSeq_2.RData")
load("./bulk/DEXSeq_3.RData")
load("./bulk/DEXSeq_4.RData")

# read NBSplice results
load("./bulk/NBSplice_1.RData")
load("./bulk/NBSplice_2.RData")

Results_all <- c(satuRn_1,
                 satuRn_2,
                 limmaDiffsplice_1,
                 limmaDiffsplice_2,
                 edgeRDiffsplice_1,
                 edgeRDiffsplice_2,
                 DRIMSeq_1,
                 DRIMSeq_2,
                 DoubleExpSeq_1,
                 DoubleExpSeq_2,
                 DEXSeq_2,
                 DEXSeq_3,
                 DEXSeq_4,
                 NBSplice_1,
                 NBSplice_2)
rm(list=setdiff(ls(), c("Results_all", "sc_results")))

bulk_results <-  as.data.frame(matrix(nrow = length(Results_all), ncol=10))

colnames(bulk_results) <- c("method", 
                            "groupSize", 
                            "TXs", 
                            "TXs_round", 
                            "user", 
                            "system", 
                            "elapsed", 
                            "DTU", 
                            "removed", 
                            "memory")

bulk_results$method <- rep(c("satuRn",
                             "limmaDiffsplice",
                             "edgeRDiffsplice",
                             "DRIMSeq",
                             "DoubleExpSeq",
                             "DEXSeq",
                             "NBSplice"),
                            times=c(18,18,18,18,18,16,18)) # add method labels

round_to <- function(x, to = 1000) round(x/to)*to

# get data in dataframe format
for (i in seq_len(nrow(bulk_results))) {
  bulk_results$groupSize[i] <- Results_all[[i]]$info$size
  bulk_results$TXs[i] <- Results_all[[i]]$info$TXs
  bulk_results$TXs_round[i] <- round_to(bulk_results$TXs[i])
  bulk_results$user[i] <- unname(Results_all[[i]]$timing[1])
  bulk_results$system[i] <- unname(Results_all[[i]]$timing[2])
  bulk_results$elapsed[i] <- unname(Results_all[[i]]$timing[3])
  bulk_results$DTU[i] <- ifelse(is.null(Results_all[[i]]$result),
                                  NA,
                                  Results_all[[i]]$result)
  bulk_results$removed[i] <- Results_all[[i]]$removed
  bulk_results$memory[i] <- Results_all[[i]]$memory[4]
}
```

```{r}
all_results <- as.data.frame(rbind(sc_results,
                                   bulk_results))
all_results$datatype <- rep(c("singlecell", "bulk"), times = c(143,124))
```

# Visualizations

## Single cell

### Scalability w.r.t. number of cells (1)

Without our method, used to generate Figure 1, panel B from our paper.

```{r}
data_30K <- sc_results[which(sc_results$TXs_round == 30000),]

png("./Results/Scalability_benchmarks/singlecell/scale_cells_intro.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K[-which(data_30K$method == "satuRn"),], aes(x=groupSize,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

### Scalability w.r.t. number of transcripts (1)

Without our method, used to generate Figure 1, panel C from our paper.

```{r}
data_16cells <- sc_results[which(sc_results$groupSize == 16),]

png("./Results/Scalability_benchmarks/singlecell/scale_transcripts_intro.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells[-which(data_16cells$method == "satuRn"),], aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#CC79A7", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```

### Scalability w.r.t. number of cells (2)

Including our method, used to generate Figure 5, panel A from our paper.

```{r}
png("./Results/Scalability_benchmarks/singlecell/scale_cells_all.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K, aes(x=groupSize,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

```{r}
# zoom
png("./Results/Scalability_benchmarks/singlecell/scale_cells_all_zoom.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K[-which(data_30K$method %in% c("DEXSeq","DRIMSeq")),], aes(x=groupSize,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#56B4E9", "#F0E442", "#0072B2","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

### Scalability w.r.t. number of transcripts (2)

Including our method, used to generate Figure 5, panel B from our paper.

```{r}
png("./Results/Scalability_benchmarks/singlecell/scale_transcripts_all.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells, aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#CC79A7", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```

```{r}
# zoom
png("./Results/Scalability_benchmarks/singlecell/scale_transcripts_all_zoom.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells[-which(data_16cells$method %in% c("BANDITS", "DEXSeq","DRIMSeq")),], aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#56B4E9", "#F0E442", "#0072B2","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```

# Bulk

```{r}
data_30K <- bulk_results[which(bulk_results$TXs_round == 30000),]

png("./Results/Scalability_benchmarks/bulk/bulk_scale_samples_all.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K, aes(x=groupSize,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#E69F00", 
                              "#56B4E9", 
                              "#009E73", 
                              "#F0E442", 
                              "#0072B2",
                              "#D55E00",
                              "black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

```{r}
# zoom
png("./Results/Scalability_benchmarks/bulk/bulk_scale_samples_all_zoom.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K[-which(data_30K$method %in% c("DEXSeq","DRIMSeq")),], aes(x=groupSize,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#56B4E9", "#F0E442", "#0072B2", "#D55E00", "black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

### Scalability w.r.t. number of transcripts (2)

```{r}
data_16cells <- bulk_results[which(bulk_results$groupSize == 16),]

png("./Results/Scalability_benchmarks/bulk/bulk_scale_transcripts_all.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells, aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                              "#0072B2", "#D55E00","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```

```{r}
# zoom
png("./Results/Scalability_benchmarks/bulk/bulk_scale_transcripts_all_zoom.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells[-which(data_16cells$method %in% c("DEXSeq",
                                                             "DRIMSeq")),],
       aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=c("#56B4E9", "#F0E442", "#0072B2", "#D55E00","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```

## Bulk versus singlecell comparison

```{r}
data_30K <- all_results[which(all_results$TXs_round == 30000),]
data_30K <- data_30K[which(data_30K$groupSize <= 64),]
data_30K <- data_30K[which(data_30K$method != "NBSplice"),] # could not run sc analysis

png("./Results/Scalability_benchmarks/comparison/scale_samples_all_comp.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K, aes(x=groupSize, y=elapsed/60, color=method)) +
  geom_line(aes(linetype=datatype)) +
  geom_point() +
  scale_color_manual(values=c("#E69F00", 
                              "#56B4E9", 
                              "#009E73", 
                              "#F0E442", 
                              "#0072B2",
                              "black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

```{r}
png("./Results/Scalability_benchmarks/comparison/scale_samples_all_zoom_comp.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_30K[-which(data_30K$method %in% c("DEXSeq","DRIMSeq")),], 
       aes(x=groupSize, y=elapsed/60, color=method)) +
  geom_line(aes(linetype=datatype)) +
  geom_point() +
  scale_color_manual(values=c("#56B4E9", 
                              "#F0E442", 
                              "#0072B2",
                              "black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of cells per group")

dev.off()
```

```{r}
data_16cells <- all_results[which(all_results$groupSize == 16),]
data_16cells <- data_16cells[which(!data_16cells$method %in% c("NBSplice",
                                                               "BANDITS")),] # could not run sc analysis

png("./Results/Scalability_benchmarks/comparison/scale_transcripts_all_comp.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells, aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line(aes(linetype=datatype)) +
  geom_point() +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                              "#0072B2","black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```

```{r}
png("/./Results/Scalability_benchmarks/comparison/scale_transcripts_all_zoom_comp.png",
  width     = 5,
  height    = 5,
  units     = "in",
  res       = 200,
  pointsize = 4)

ggplot(data = data_16cells[-which(data_16cells$method %in% c("DEXSeq","DRIMSeq")),],
       aes(x=TXs,y=elapsed/60,color=method)) +
  geom_line(aes(linetype=datatype)) +
  geom_point() +
  scale_color_manual(values=c("#56B4E9", "#F0E442", "#0072B2", "black")) +
  theme_bw() +
  ylab("elapsed  time (min)") + 
  xlab("number of transcripts")

dev.off()
```





